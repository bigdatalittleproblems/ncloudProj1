{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "",
    "Parameters": {
        "amiparam": {
            "Description": "select your AIM",
            "Type": "String",
            "Default": "ami-0533f2ba8a1995cf9",
            "AllowedValues": [
                "ami-0533f2ba8a1995cf9",
                "ami-042e8287309f5df03"
            ]
        },
        "ec2volsize": {
            "Description": "size of ec2 EBS Volume",
            "Type": "Number",
            "Default": "20"
        },
        "instancetypeparam": {
            "Description": "Instance Type",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t2.micro",
                "m1.small",
                "m1.large"
            ]
        },
        "asgmax": {
            "Description": "ASG Max instances",
            "Type": "Number",
            "Default": "3"
        },
        "asgmin": {
            "Description": "ASG Min instance",
            "Type": "Number",
            "Default": "2"
        }
    },
    "Resources": {
        "proj1cluster": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "CapacityProviders": [
                    {
                        "Ref": "proj1CapProvider"
                    }
                ],
                "ClusterName": "project1_cluster"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "69ee13c6-0c25-4a70-af0e-c17ece8f224e"
                }
            }
        },
        "proj1CapProvider": {
            "Type": "AWS::ECS::CapacityProvider",
            "Properties": {
                "AutoScalingGroupProvider": {
                    "AutoScalingGroupArn": {
                        "Ref": "proj1asg"
                    }
                },
                "Name": "proj1CapProvider"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "54ed43b9-89bb-4903-bcb7-bfcaef459088"
                }
            }
        },
        "proj1lbtarget": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": "proj1lbtarget",
                "VpcId": {
                    "Ref": "myVPC"
                },
                "Protocol": "HTTP",
                "Port": 80
            }
        },
        "proj1lblisten": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "TargetGroupArn": {
                            "Ref": "proj1lbtarget"
                        },
                        "Type": "forward"
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "proj1LoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "proj1LoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Subnets": [
                    {
                        "Ref": "publicsubnet1"
                    },
                    {
                        "Ref": "publicsubnet2"
                    }
                ],
                "Type": "application"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "bc7b922b-b1b9-4c2b-9afd-a0ca0e36bc59"
                }
            }
        },
        "proj1ecsservice": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "Cluster": {
                    "Ref": "proj1cluster"
                },
                "DesiredCount": 1,
                "LaunchType": "EC2",
                "TaskDefinition": {
                    "Ref": "proj1taskdef"
                },
                "LoadBalancers": [
                    {
                        "ContainerName": "nginx",
                        "ContainerPort": 80,
                        "TargetGroupArn": {
                            "Ref": "proj1lbtarget"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "188ffcf8-7aa1-41a4-ba02-fe457371816c"
                }
            }
        },
        "proj1taskdef": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "ExecutionRoleArn": "arn:aws:iam::671538735556:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS",
                "ContainerDefinitions": [
                    {
                        "MemoryReservation": 128,
                        "Image": "public.ecr.aws/nginx/nginx:latest",
                        "Name": "nginx",
                        "PortMappings": [
                            {
                                "ContainerPort": "80"
                            }
                        ]
                    }
                ]
            }
        },
        "proj1taskdefbackup": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "MemoryReservation": 128,
                        "Image": "public.ecr.aws/v1i0e6j5/kong:latest",
                        "Name": "kong",
                        "PortMappings": [
                            {
                                "ContainerPort": "8000"
                            },
                            {
                                "ContainerPort": "5432"
                            },
                            {
                                "ContainerPort": "8001",
                                "HostPort": "8001"
                            },
                            {
                                "ContainerPort": "8443",
                                "HostPort": "8443"
                            }
                        ],
                        "Environment": [
                            {
                                "Name": "KONG_PROXY_ACCESS_LOG",
                                "Value": "/dev/stdout"
                            },
                            {
                                "Name": "KONG_ADMIN_ACCESS_LOG",
                                "Value": "/dev/stdout"
                            },
                            {
                                "Name": "KONG_PROXY_ERROR_LOG",
                                "Value": "/dev/stderr"
                            },
                            {
                                "Name": "KONG_ADMIN_ERROR_LOG",
                                "Value": "/dev/stderr"
                            },
                            {
                                "Name": "KONG_ADMIN_LISTEN",
                                "Value": "0.0.0.0:8001"
                            }
                        ]
                    },
                    {
                        "MemoryReservation": 128,
                        "Image": "public.ecr.aws/v1i0e6j5/flask:latest",
                        "Name": "flask",
                        "PortMappings": [
                            {
                                "ContainerPort": "5000",
                                "HostPort": "80"
                            }
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c2c88d05-c7e7-4132-b6b8-c0f501d10c09"
                }
            }
        },
        "proj1asg": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "VPCZoneIdentifier": [
                    {
                        "Ref": "publicsubnet1"
                    },
                    {
                        "Ref": "publicsubnet2"
                    }
                ],
                "LaunchConfigurationName": {
                    "Ref": "crlaunchConfig"
                },
                "MaxSize": {
                    "Ref": "asgmax"
                },
                "MinSize": {
                    "Ref": "asgmin"
                },
                "TargetGroupARNs": [
                    {
                        "Ref": "proj1lbtarget"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "38d03e89-fa90-423f-aadc-aa7a8e28f1bc"
                }
            }
        },
        "crlaunchConfig": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": {
                    "Ref": "amiparam"
                },
                "InstanceType": {
                    "Ref": "instancetypeparam"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": {
                                "Ref": "ec2volsize"
                            },
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "vpcsg"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "81959a1e-7ff5-4952-9bb6-759c26706ade"
                }
            }
        },
        "myVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                }
            }
        },
        "vpcsg": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "master SG for Proj1",
                "GroupName": "proj1sg",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": 5000,
                        "ToPort": 5000
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": 5432,
                        "ToPort": 5432
                    }
                ],
                "VpcId": {
                    "Ref": "myVPC"
                }
            }
        },
        "containerSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "containerSG",
                "GroupName": "containerSG",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupId": {
                            "Ref": "vpcsg"
                        },
                        "FromPort": 5000,
                        "ToPort": 5000
                    },
                    {
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupId": {
                            "Ref": "vpcsg"
                        },
                        "FromPort": 5432,
                        "ToPort": 5432
                    }
                ],
                "VpcId": {
                    "Ref": "myVPC"
                }
            }
        },
        "publicsubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "myVPC",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e"
                }
            }
        },
        "publicsubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "myVPC",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f8abf819-cc5b-4d19-bb29-220fb4dd4325"
                }
            }
        },
        "privatesubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "myVPC",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ea9c45fb-065a-4b51-a541-2ff19fdf53f0"
                }
            }
        },
        "privatesubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        3,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "myVPC",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "49b9c7dc-bee3-4d64-91a1-643d550f1d1d"
                }
            }
        },
        "publicrt": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9b5841e7-b1a4-4037-a890-98e430e6621f"
                }
            }
        },
        "privatert": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2175295f-32b0-4237-8e5a-6ccc085502ac"
                }
            }
        },
        "mainigw": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "acbe6b9a-b145-4464-8a92-37500e608772"
                }
            }
        },
        "mainroute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "publicrt"
                },
                "GatewayId": {
                    "Ref": "mainigw"
                },
                "DestinationCidrBlock": "0.0.0.0/0"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b5105be6-4684-467d-b9cd-d3bbd98f9025"
                }
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "InternetGatewayId": {
                    "Ref": "mainigw"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "6dd159fd-7f39-4835-8e91-1daa430254b8"
                }
            }
        },
        "subnetassociation1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "publicsubnet1"
                },
                "RouteTableId": {
                    "Ref": "publicrt"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "439b87ae-7a72-4822-b647-1c4704fef94e"
                }
            }
        },
        "subnetassociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "publicsubnet2"
                },
                "RouteTableId": {
                    "Ref": "publicrt"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1435bb5d-f29b-44f4-92f3-9ebe0c447b52"
                }
            }
        },
        "subnetassociationPrivate1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "privatesubnet1"
                },
                "RouteTableId": {
                    "Ref": "privatert"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2f4dd485-1c1c-4e49-9e66-9292e572cbb0"
                }
            }
        },
        "subnetassociationPrivate2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "privatesubnet2"
                },
                "RouteTableId": {
                    "Ref": "privatert"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d41140ef-1bfc-4be8-a7e4-d07f7dffde68"
                }
            }
        }
    },
    "Outputs": {}
}