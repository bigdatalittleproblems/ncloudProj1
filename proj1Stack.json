{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Proj1 nCloud CloudFormation created by Christian Ramirez Using Kong",
    "Parameters": {
        "KPName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the ECS instances.",
            "Default": "cr_wsl"
        },
        "instancetypeparam": {
            "Description": "Instance Type",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t2.micro",
                "m1.small",
                "m1.large"
            ]
        },
        "asgmax": {
            "Description": "ASG Max instances",
            "Type": "Number",
            "Default": "3"
        },
        "asgmin": {
            "Description": "ASG Min instance",
            "Type": "Number",
            "Default": "1"
        },
        "DesiredCapacity": {
            "Type": "Number",
            "Default": "2",
            "Description": "Number of instances to launch in your ECS cluster."
        }
    },
    "Mappings": {
        "AWSRegionToAMI": {
            "us-east-1": {
                "AMIID": "ami-09bee01cc997a78a6"
            },
            "us-east-2": {
                "AMIID": "ami-0a9e12068cb98a01d"
            },
            "us-west-1": {
                "AMIID": "ami-0fa6c8d131a220017"
            },
            "us-west-2": {
                "AMIID": "ami-078c97cf1cefd1b38"
            },
            "eu-west-1": {
                "AMIID": "ami-0c9ef930279337028"
            },
            "eu-central-1": {
                "AMIID": "ami-065c1e34da68f2b02"
            },
            "ap-northeast-1": {
                "AMIID": "ami-02265963d1614d04d"
            },
            "ap-southeast-1": {
                "AMIID": "ami-0b68661b29b9e058c"
            },
            "ap-southeast-2": {
                "AMIID": "ami-00e4b147599c13588"
            }
        }
    },
    "Resources": {
        "ECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "ClusterName": "project1_cluster"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "69ee13c6-0c25-4a70-af0e-c17ece8f224e"
                }
            }
        },
        "ECSTG": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckPath": "/healthcheck",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "Matcher": {
                    "HttpCode": "200-404"
                },
                "Port": 10,
                "Protocol": "HTTP",
                "Name": "ECSTG",
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a26ad1d5-7ddb-4be2-af65-71c1d7e722a2"
                }
            }
        },
        "ECSALBListenerRule": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "DependsOn": "ALBListener",
            "Properties": {
                "Actions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ECSTG"
                        }
                    }
                ],
                "Conditions": [
                    {
                        "Field": "path-pattern",
                        "PathPatternConfig": {
                            "Values": [
                                "/"
                            ]
                        }
                    }
                ],
                "ListenerArn": {
                    "Ref": "ALBListener"
                },
                "Priority": 1
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "TargetGroupArn": {
                            "Ref": "ECSTG"
                        },
                        "Type": "forward"
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ECSALB"
                },
                "Protocol": "HTTP",
                "Port": 80
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "45d9f3de-8799-4ac2-b991-d0382bef6d00"
                }
            }
        },
        "ECSALB": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Ref": "ALBSG"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "Subnet1"
                    },
                    {
                        "Ref": "Subnet2"
                    }
                ],
                "Type": "application"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "bc7b922b-b1b9-4c2b-9afd-a0ca0e36bc59"
                }
            }
        },
        "AdminALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "TargetGroupArn": {
                            "Ref": "AdminTG"
                        },
                        "Type": "forward"
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ECSALB"
                },
                "Protocol": "HTTP",
                "Port": 8001
            }
        },
        "AdminTG": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "Matcher": {
                    "HttpCode": "200-399"
                },
                "Port": 11,
                "Protocol": "HTTP",
                "Name": "AdminTG",
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            }
        },
        "AdminALBListenerRule": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "DependsOn": "ALBListener",
            "Properties": {
                "Actions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "AdminTG"
                        }
                    }
                ],
                "Conditions": [
                    {
                        "Field": "path-pattern",
                        "PathPatternConfig": {
                            "Values": [
                                "/"
                            ]
                        }
                    }
                ],
                "ListenerArn": {
                    "Ref": "ALBListener"
                },
                "Priority": 2
            }
        },
        "ECSServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ecs.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "ecs-service",
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",
                                        "elasticloadbalancing:DeregisterTargets",
                                        "elasticloadbalancing:Describe*",
                                        "elasticloadbalancing:RegisterInstancesWithLoadBalancer",
                                        "elasticloadbalancing:RegisterTargets",
                                        "ec2:Describe*",
                                        "ec2:AuthorizeSecurityGroupIngress"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateNamespace": {
            "Type": "AWS::ServiceDiscovery::PrivateDnsNamespace",
            "Properties": {
                "Name": "proj1",
                "Vpc": {
                    "Ref": "ECSVpc"
                }
            }
        },
        "ECSDiscoveryService": {
            "Type": "AWS::ServiceDiscovery::Service",
            "Properties": {
                "Description": "Discovery Service for the Demo Application",
                "DnsConfig": {
                    "RoutingPolicy": "WEIGHTED",
                    "DnsRecords": [
                        {
                            "TTL": 60,
                            "Type": "A"
                        },
                        {
                            "TTL": 60,
                            "Type": "SRV"
                        }
                    ]
                },
                "HealthCheckCustomConfig": {
                    "FailureThreshold": 1
                },
                "Name": "proj1",
                "NamespaceId": {
                    "Ref": "PrivateNamespace"
                }
            }
        },
        "ECSservice": {
            "Type": "AWS::ECS::Service",
            "DependsOn": [
                "ALBListener",
                "ECSALB",
                "ECSTG"
            ],
            "Properties": {
                "Cluster": {
                    "Ref": "ECSCluster"
                },
                "DesiredCount": 2,
                "LaunchType": "EC2",
                "TaskDefinition": {
                    "Ref": "ECStaskdefinition"
                },
                "ServiceName": "Proj1ECSservice",
                "ServiceRegistries": [
                    {
                        "ContainerName": "flask",
                        "ContainerPort": 5000,
                        "RegistryArn": {
                            "Fn::GetAtt": [
                                "ECSDiscoveryService",
                                "Arn"
                            ]
                        }
                    }
                ],
                "LoadBalancers": [
                    {
                        "ContainerName": "kong",
                        "ContainerPort": 8000,
                        "TargetGroupArn": {
                            "Ref": "ECSTG"
                        }
                    },
                    {
                        "ContainerName": "kong",
                        "ContainerPort": 8001,
                        "TargetGroupArn": {
                            "Ref": "AdminTG"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "188ffcf8-7aa1-41a4-ba02-fe457371816c"
                }
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ]
            }
        },
        "TaskBackup": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    {
                        "MemoryReservation": 128,
                        "Image": "public.ecr.aws/nginx/nginx:latest",
                        "Name": "nginx",
                        "PortMappings": [
                            {
                                "ContainerPort": "80"
                            }
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a765afa1-6723-4e0b-977f-e8c2c419f27d"
                }
            }
        },
        "ECStaskdefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "NetworkMode": "bridge",
                "ContainerDefinitions": [
                    {
                        "MemoryReservation": 128,
                        "Image": "docker.io/bitnami/kong:latest",
                        "Name": "kong",
                        "PortMappings": [
                            {
                                "ContainerPort": "8000"
                            },
                            {
                                "ContainerPort": "8001"
                            }
                        ],
                        "Environment": [
                            {
                                "Name": "KONG_PG_HOST",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "kongdb",
                                        "Endpoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "KONG_PG_PASSWORD",
                                "Value": "pXDKPTsA3Kbe3F7qcMJT"
                            },
                            {
                                "Name": "KONG_ADMIN_LISTEN_ADDRESS",
                                "Value": "0.0.0.0"
                            },
                            {
                                "Name": "KONG_MIGRATE",
                                "Value": "yes"
                            }
                        ]
                    },
                    {
                        "MemoryReservation": 128,
                        "Image": "public.ecr.aws/v1i0e6j5/flask:latest",
                        "Name": "flask",
                        "PortMappings": [
                            {
                                "ContainerPort": "5000"
                            }
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c2c88d05-c7e7-4132-b6b8-c0f501d10c09"
                }
            }
        },
        "ECSAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "VPCZoneIdentifier": [
                    {
                        "Ref": "Subnet1"
                    },
                    {
                        "Ref": "Subnet2"
                    }
                ],
                "LaunchConfigurationName": {
                    "Ref": "ContainerInstances"
                },
                "MaxSize": {
                    "Ref": "asgmax"
                },
                "MinSize": {
                    "Ref": "asgmin"
                },
                "DesiredCapacity": {
                    "Ref": "DesiredCapacity"
                },
                "TargetGroupARNs": [
                    {
                        "Ref": "ECSTG"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "38d03e89-fa90-423f-aadc-aa7a8e28f1bc"
                }
            }
        },
        "ContainerInstances": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSRegionToAMI",
                        {
                            "Ref": "AWS::Region"
                        },
                        "AMIID"
                    ]
                },
                "KeyName": {
                    "Ref": "KPName"
                },
                "InstanceType": {
                    "Ref": "instancetypeparam"
                },
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EcsSecurityGroup"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -xe\n",
                                "echo ECS_CLUSTER=",
                                {
                                    "Ref": "ECSCluster"
                                },
                                " >> /etc/ecs/ecs.config\n",
                                "yum install -y aws-cfn-bootstrap\n",
                                "/opt/aws/bin/cfn-signal -e $? ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource ECSAutoScalingGroup ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "81959a1e-7ff5-4952-9bb6-759c26706ade"
                }
            }
        },
        "ECSVpc": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                }
            }
        },
        "EcsSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "master SG for Proj1",
                "GroupName": "proj1sg",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSG"
                        },
                        "FromPort": -1,
                        "ToPort": -1
                    }
                ],
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f1a54262-6bb9-46bf-ad09-9b1c1089261e"
                }
            }
        },
        "EcsSecurityGroupSSHinbound": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "EcsSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "EcsSecurityGroupALBports": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "EcsSecurityGroup"
                },
                "IpProtocol": "-1",
                "FromPort": -1,
                "ToPort": -1,
                "SourceSecurityGroupId": {
                    "Ref": "EcsSecurityGroup"
                }
            }
        },
        "ALBSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "ALBSG",
                "GroupName": "ALBSG",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": 80,
                        "ToPort": 80
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": 443,
                        "ToPort": 443
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": 8001,
                        "ToPort": 8001
                    }
                ],
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9234ed59-9d62-47ca-8259-c355e4d3dd87"
                }
            }
        },
        "Subnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "MapPublicIpOnLaunch": true,
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "ECSVpc"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "ECSVpc",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e"
                }
            }
        },
        "Subnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "MapPublicIpOnLaunch": true,
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "ECSVpc"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "ECSVpc",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f8abf819-cc5b-4d19-bb29-220fb4dd4325"
                }
            }
        },
        "NAT": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "Subnet1"
                }
            }
        },
        "IgwAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "mainigw"
                },
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            }
        },
        "EIP": {
            "DependsOn": "VPCGatewayAttach",
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "PrivateRT": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "privatert"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NAT"
                }
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "ECSVpc"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "ECSVpc",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ea9c45fb-065a-4b51-a541-2ff19fdf53f0"
                }
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "VpcId": {
                    "Ref": "ECSVpc"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        3,
                        {
                            "Fn::Cidr": [
                                {
                                    "Fn::GetAtt": [
                                        "ECSVpc",
                                        "CidrBlock"
                                    ]
                                },
                                "4",
                                "8"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "49b9c7dc-bee3-4d64-91a1-643d550f1d1d"
                }
            }
        },
        "publicrt": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9b5841e7-b1a4-4037-a890-98e430e6621f"
                }
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "ecs-service",
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecs:CreateCluster",
                                        "ecs:DeregisterContainerInstance",
                                        "ecs:DiscoverPollEndpoint",
                                        "ecs:Poll",
                                        "ecs:RegisterContainerInstance",
                                        "ecs:StartTelemetrySession",
                                        "ecs:Submit*",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "privatert": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2175295f-32b0-4237-8e5a-6ccc085502ac"
                }
            }
        },
        "mainigw": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "acbe6b9a-b145-4464-8a92-37500e608772"
                }
            }
        },
        "mainroute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "publicrt"
                },
                "GatewayId": {
                    "Ref": "mainigw"
                },
                "DestinationCidrBlock": "0.0.0.0/0"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b5105be6-4684-467d-b9cd-d3bbd98f9025"
                }
            }
        },
        "VPCGatewayAttach": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "ECSVpc"
                },
                "InternetGatewayId": {
                    "Ref": "mainigw"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "6dd159fd-7f39-4835-8e91-1daa430254b8"
                }
            }
        },
        "subnetassociation1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "Subnet1"
                },
                "RouteTableId": {
                    "Ref": "publicrt"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "439b87ae-7a72-4822-b647-1c4704fef94e"
                }
            }
        },
        "subnetassociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "Subnet2"
                },
                "RouteTableId": {
                    "Ref": "publicrt"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1435bb5d-f29b-44f4-92f3-9ebe0c447b52"
                }
            }
        },
        "subnetassociationPrivate1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "privatert"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2f4dd485-1c1c-4e49-9e66-9292e572cbb0"
                }
            }
        },
        "subnetassociationPrivate2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "privatert"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d41140ef-1bfc-4be8-a7e4-d07f7dffde68"
                }
            }
        },
        "dbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "DB Security Group to allow proj1sg",
                "GroupName": "dbSecurityGroup",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "SourceSecurityGroupId": {
                            "Ref": "EcsSecurityGroup"
                        },
                        "FromPort": -1,
                        "ToPort": -1
                    }
                ],
                "VpcId": {
                    "Ref": "ECSVpc"
                }
            }
        },
        "kongdb": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "AllocatedStorage": "30",
                "AllowMajorVersionUpgrade": "False",
                "BackupRetentionPeriod": 0,
                "DBName": "kong",
                "DeletionProtection": "False",
                "Engine": "postgres",
                "MasterUsername": "kong",
                "MasterUserPassword": "pXDKPTsA3Kbe3F7qcMJT",
                "MultiAZ": "False",
                "DBInstanceClass": "db.t3.micro",
                "DBSubnetGroupName": {
                    "Ref": "kongDBSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "dbSecurityGroup"
                    }
                ]
            }
        },
        "kongDBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "Subnet where Kong will be Deployed",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "ecsservice": {
            "Value": {
                "Ref": "ECSservice"
            }
        },
        "ecscluster": {
            "Value": {
                "Ref": "ECSCluster"
            }
        },
        "ECSALB": {
            "Description": "Your ALB DNS URL",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        {
                            "Fn::GetAtt": [
                                "ECSALB",
                                "DNSName"
                            ]
                        }
                    ]
                ]
            }
        },
        "taskdef": {
            "Value": {
                "Ref": "ECStaskdefinition"
            }
        },
        "kongdb": {
            "Value": {
                "Fn::GetAtt": [
                    "kongdb",
                    "Endpoint.Address"
                ]
            }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "acbe6b9a-b145-4464-8a92-37500e608772": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 60,
                    "y": 840
                },
                "z": 1,
                "embeds": []
            },
            "9cc82114-b3f7-462d-b53c-d9080ed8a973": {
                "size": {
                    "width": 780,
                    "height": 690
                },
                "position": {
                    "x": 60,
                    "y": 90
                },
                "z": 1,
                "embeds": [
                    "2175295f-32b0-4237-8e5a-6ccc085502ac",
                    "9b5841e7-b1a4-4037-a890-98e430e6621f",
                    "49b9c7dc-bee3-4d64-91a1-643d550f1d1d",
                    "ea9c45fb-065a-4b51-a541-2ff19fdf53f0",
                    "f8abf819-cc5b-4d19-bb29-220fb4dd4325",
                    "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e",
                    "f1a54262-6bb9-46bf-ad09-9b1c1089261e",
                    "9234ed59-9d62-47ca-8259-c355e4d3dd87",
                    "a26ad1d5-7ddb-4be2-af65-71c1d7e722a2"
                ]
            },
            "6dd159fd-7f39-4835-8e91-1daa430254b8": {
                "source": {
                    "id": "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                },
                "target": {
                    "id": "acbe6b9a-b145-4464-8a92-37500e608772"
                }
            },
            "2175295f-32b0-4237-8e5a-6ccc085502ac": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 600,
                    "y": 360
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "9b5841e7-b1a4-4037-a890-98e430e6621f": {
                "size": {
                    "width": 240,
                    "height": 240
                },
                "position": {
                    "x": 90,
                    "y": 150
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [
                    "b5105be6-4684-467d-b9cd-d3bbd98f9025"
                ],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "b5105be6-4684-467d-b9cd-d3bbd98f9025": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 120,
                    "y": 210
                },
                "z": 3,
                "parent": "9b5841e7-b1a4-4037-a890-98e430e6621f",
                "embeds": [],
                "isassociatedwith": [
                    "acbe6b9a-b145-4464-8a92-37500e608772"
                ],
                "iscontainedinside": [
                    "9b5841e7-b1a4-4037-a890-98e430e6621f"
                ]
            },
            "49b9c7dc-bee3-4d64-91a1-643d550f1d1d": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 600,
                    "y": 150
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "d41140ef-1bfc-4be8-a7e4-d07f7dffde68": {
                "source": {
                    "id": "2175295f-32b0-4237-8e5a-6ccc085502ac"
                },
                "target": {
                    "id": "49b9c7dc-bee3-4d64-91a1-643d550f1d1d"
                }
            },
            "ea9c45fb-065a-4b51-a541-2ff19fdf53f0": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 90,
                    "y": 450
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "2f4dd485-1c1c-4e49-9e66-9292e572cbb0": {
                "source": {
                    "id": "2175295f-32b0-4237-8e5a-6ccc085502ac"
                },
                "target": {
                    "id": "ea9c45fb-065a-4b51-a541-2ff19fdf53f0"
                }
            },
            "f8abf819-cc5b-4d19-bb29-220fb4dd4325": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 390,
                    "y": 360
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "1435bb5d-f29b-44f4-92f3-9ebe0c447b52": {
                "source": {
                    "id": "9b5841e7-b1a4-4037-a890-98e430e6621f"
                },
                "target": {
                    "id": "f8abf819-cc5b-4d19-bb29-220fb4dd4325"
                }
            },
            "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 390,
                    "y": 150
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "439b87ae-7a72-4822-b647-1c4704fef94e": {
                "source": {
                    "id": "9b5841e7-b1a4-4037-a890-98e430e6621f"
                },
                "target": {
                    "id": "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e"
                }
            },
            "f1a54262-6bb9-46bf-ad09-9b1c1089261e": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 570
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "9234ed59-9d62-47ca-8259-c355e4d3dd87": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 420,
                    "y": 570
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "81959a1e-7ff5-4952-9bb6-759c26706ade": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 840
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "f1a54262-6bb9-46bf-ad09-9b1c1089261e"
                ]
            },
            "c2c88d05-c7e7-4132-b6b8-c0f501d10c09": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 840
                },
                "z": 1,
                "embeds": []
            },
            "a765afa1-6723-4e0b-977f-e8c2c419f27d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 420,
                    "y": 840
                },
                "z": 1,
                "embeds": []
            },
            "bc7b922b-b1b9-4c2b-9afd-a0ca0e36bc59": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 540,
                    "y": 840
                },
                "z": 1,
                "embeds": [],
                "iscontainedinside": [
                    "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e",
                    "f8abf819-cc5b-4d19-bb29-220fb4dd4325"
                ]
            },
            "a26ad1d5-7ddb-4be2-af65-71c1d7e722a2": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 540,
                    "y": 570
                },
                "z": 2,
                "parent": "9cc82114-b3f7-462d-b53c-d9080ed8a973",
                "embeds": [],
                "iscontainedinside": [
                    "9cc82114-b3f7-462d-b53c-d9080ed8a973"
                ]
            },
            "38d03e89-fa90-423f-aadc-aa7a8e28f1bc": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 660,
                    "y": 840
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "81959a1e-7ff5-4952-9bb6-759c26706ade",
                    "a26ad1d5-7ddb-4be2-af65-71c1d7e722a2"
                ],
                "iscontainedinside": [
                    "58619c9b-9fa8-47fb-9f5d-1ac66f57d71e",
                    "f8abf819-cc5b-4d19-bb29-220fb4dd4325"
                ]
            },
            "45d9f3de-8799-4ac2-b991-d0382bef6d00": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 780,
                    "y": 840
                },
                "z": 1,
                "embeds": []
            },
            "54ed43b9-89bb-4903-bcb7-bfcaef459088": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 900,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "69ee13c6-0c25-4a70-af0e-c17ece8f224e": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 900,
                    "y": 210
                },
                "z": 1,
                "embeds": []
            },
            "188ffcf8-7aa1-41a4-ba02-fe457371816c": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 900,
                    "y": 330
                },
                "z": 1,
                "embeds": []
            }
        }
    }
}